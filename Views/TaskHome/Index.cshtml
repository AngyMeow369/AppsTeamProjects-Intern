@model IEnumerable<TaskLoggerV1.Models.TaskModel>

@{
    ViewBag.Title = "Task View Manager";
}

<h2>Task View Manager</h2>

<!-- Anti-forgery token for AJAX posts -->
@Html.AntiForgeryToken()

<div class="mb-3">
    <button id="btnCreate" class="btn btn-success">Create New Task</button>
</div>

<div class="mb-3">
    <input type="date" id="searchDate" class="form-control d-inline-block" style="width: 200px;" />
    <button id="btnSearch" class="btn btn-primary">Search</button>
</div>

<!-- Container for modals or partials -->
<div id="modalContainer"></div>

<!-- Container for task list -->
<div id="taskList">
    @Html.Partial("_SearchTaskPartial", Model)
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        // -----------------------------
        // Load Create form in modal
        // -----------------------------
        $("#btnCreate").click(function () {
            $.get('@Url.Action("Create", "TaskHome")', function (html) {
                $("#modalContainer").html(html);
                $("#createTaskModal").modal("show");
            });
        });

        // -----------------------------
        // Search tasks by date
        // -----------------------------
        $("#btnSearch").click(function () {
            var date = $("#searchDate").val();
            $.get('@Url.Action("Search", "TaskHome")', { date: date }, function (html) {
                $("#taskList").html(html);
            });
        });

        // -----------------------------
        // Edit task in modal
        // -----------------------------
        $(document).on("click", ".btn-edit", function () {
            var id = $(this).data("id");
            $.get('@Url.Action("Edit", "TaskHome")', { id: id }, function (html) {
                $("#modalContainer").html(html);
                $("#editTaskModal").modal("show");
            });
        });

        // -----------------------------
        // Delete task in modal (NOT confirm)
        // -----------------------------
        $(document).on("click", ".btn-delete", function () {
            var id = $(this).data("id");
            $.get('@Url.Action("Delete", "TaskHome")', { id: id }, function (html) {
                $("#modalContainer").html(html);
                $("#deleteTaskModal").modal("show");
            });
        });

        // -----------------------------
        // AJAX form submission (Create/Edit/Delete)
        // -----------------------------
        $(document).on("submit", "form", function (e) {
            e.preventDefault();
            var form = $(this);

            $.ajax({
                url: form.attr("action"),
                type: form.attr("method"),
                data: form.serialize(),
                success: function (res) {
                    if (res.success) {
                        $("#taskList").html(res.html);   // refresh task list
                        $(".modal").modal("hide");       // close modal
                    } else {
                        // if validation failed, re-render modal
                        $("#modalContainer").html(res);
                        $(".modal").modal("show");
                    }
                },
                error: function () {
                    alert("Something went wrong.");
                }
            });
        });
    </script>
}

