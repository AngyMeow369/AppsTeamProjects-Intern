@model IEnumerable<TaskLoggerV1.Models.TaskModel>

@{
    ViewBag.Title = "Task View Manager";
}

<h2>Task View Manager</h2>

<!-- Anti-forgery token for AJAX posts -->
@Html.AntiForgeryToken()

<div class="mb-3">
    <button id="btnCreate" class="btn btn-success">Create New Task</button>
</div>

<div class="mb-3">
    <input type="date" id="searchDate" class="form-control d-inline-block" style="width: 200px;" />
    <button id="btnSearch" class="btn btn-primary">Search</button>
</div>

<!-- Container for modals or partials -->
<div id="modalContainer"></div>

<!-- Container for task list -->
<div id="taskList">
    @Html.Partial("_SearchTaskPartial", Model)
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // Load Create form
        $("#btnCreate").click(function () {
            $.get('@Url.Action("Create", "TaskHome")', function (html) {
                $("#modalContainer").html(html);
            });
        });

        // Search tasks by date
        $("#btnSearch").click(function () {
            var date = $("#searchDate").val();
            $.get('@Url.Action("Search", "TaskHome")', { date: date }, function (html) {
                $("#taskList").html(html);
            });
        });

        // Edit task button
        $(document).on("click", ".btn-edit", function () {
            var id = $(this).data("id");
            $.get('@Url.Action("Edit", "TaskHome")', { id: id }, function (html) {
                $("#modalContainer").html(html);
            });
        });

        // Delete task with simple confirm popup
        $(document).on("click", ".btn-delete", function () {
            var taskId = $(this).data("id");
            if (confirm("Are you sure you want to delete this task?")) {
                var token = $('input[name="__RequestVerificationToken"]').val();

                $.ajax({
                    url: '@Url.Action("Delete", "TaskHome")',
                    type: 'POST',
                    data: { id: taskId, __RequestVerificationToken: token },
                    success: function (res) {
                        if (res.success) {
                            $("#taskRow_" + taskId).remove(); // remove the row dynamically
                            alert("Task deleted successfully!");
                        } else {
                            alert("Failed to delete task: " + (res.error || ""));
                        }
                    },
                    error: function () {
                        alert("Error deleting task.");
                    }
                });
            }
        });
    </script>
}

